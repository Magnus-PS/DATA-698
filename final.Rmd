---
title: 'DATA 698 Final Research Project'
author: "Magnus Skonberg"
date: "`r Sys.Date()`" # Due 5/11/2021
output:
  html_document:
    toc: yes
    toc_float: yes
    number_sections: no
    theme: flatly
    highlight: tango
  pdf_document:
    latex_engine: xelatex
    toc: yes
---

```{=html}
<style type="text/css">

code {
  font-family: "Consolas";
  font-size: 11px;
}

pre {
  font-family: "Consolas";
  font-size: 11px;
}

</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F, eval = T) 
knitr::opts_chunk$set(fig.width=12, fig.height=8)

library(tidyverse)
library(dplyr)
library(readr)
library(ggplot2)
library(RCurl)
library(rvest)
library(stringr)
library(tidyr)
library(kableExtra)
library(BBmisc)
library(tm)
library(sqldf)
library(inspectdf)
library(corrplot)
library(MASS)

options(scipen = 9)
set.seed(123)
```

## Abstract

TBD

## Introduction

### Author

### The Problem

## Literature Review

To be amended ...

## Methodology

* Data Gathering & Pre-Processing
* Data Exploration & Preparation
* Multivariate Regression Analysis

## Experimentation & Results

### Data Gathering & Preprocessing

In order to create our dependent 'health score' variable, I first familiarized myself with the data at hand. 

Life expectancy, obesity, and physical activity data were downloaded from the [Institute for Health Metrics and Evaluation](http://www.healthdata.org/us-health/data-download) and converted to a csv-compatible form, where then a subset of columns were selected for our consideration for the creation of a dependent 'health score' variable.

* For **life expectancy data** we read in: `Male life expectancy, 2010 (years)`, `Female life expectancy, 2010 (years)`, `Difference in male life expectancy, 1985-2010 (years)`, and	`Difference in female life expectancy, 1985-2010 (years)`.
* For **obesity data** we read in: `Male obesity prevalence, 2009 (%)`, `Female obesity  prevalence, 2009 (%)`, `Difference in male obesity prevalence, 2001-2009 (percentage points)`, and `Difference in female obesity prevalence, 2001-2009 (percentage points)`.
* For **physical activity data** we read in: `Male sufficient physical activity  prevalence, 2009 (%)`, `Female sufficient physical activity  prevalence, 2009 (%)`, `Difference in male sufficient physical activity prevalence, 2001-2009 (percentage points)`, and `Difference in female sufficient physical activity prevalence, 2001-2009 (percentage points)`.

```{r, comment=FALSE, warning=FALSE, message=FALSE, include = FALSE}

#Read in life expectancy data, convert to tibble, and select pertinent columns:
longevity <- read_csv("https://raw.githubusercontent.com/Magnus-PS/DATA-698/data/IHME_LifeExpectancy.csv")
life_table <- as_tibble(longevity)
life_table <- life_table %>% dplyr::select(1:2,13:16) %>% na.omit()

#Read in obesity data, convert to tibble, and select pertinent columns:
obesity <- read_csv("https://raw.githubusercontent.com/Magnus-PS/DATA-698/data/IHME_Obesity.csv")
obesity_table <- as_tibble(obesity)
obesity_table <- obesity_table %>% dplyr::select(1:2,5:6,9:10) %>% na.omit()

#Read in physical activity data, convert to tibble, and select pertinent columns:
activity <- read_csv("https://raw.githubusercontent.com/Magnus-PS/DATA-698/data/IHME_PhysicalActivity.csv")
act_table <- as_tibble(activity)
act_table <- act_table %>% dplyr::select(1:2,5:6,9:10) %>% na.omit()

###LIFE EXPECTANCY DATA: exploration, normalization, and compilation

#Explore life expectancy data at a county level:
glimpse(life_table)
summary(life_table)

#Extract variables of interest
m1 <- life_table$`Male life expectancy, 2010 (years)`
f1 <- life_table$`Female life expectancy, 2010 (years)`
dm1 <- life_table$`Difference in male life expectancy, 1985-2010 (years)`
df1 <- life_table$`Difference in female life expectancy, 1985-2010 (years)`

#Normalize data scale to be from 0 to 1
n_m1 = (m1-min(m1))/(max(m1)-min(m1))
n_f1 = (f1-min(f1))/(max(f1)-min(f1))
n_dm1 = (dm1-min(dm1))/(max(dm1)-min(dm1))
n_df1 = (df1-min(df1))/(max(df1)-min(df1))

#Histogram of original vs. normalized data
##Life expectancy histograms
par(mfrow=c(2,2))
hist(m1, breaks=10, xlab="Age (years)", col="lightblue", main="Male life expectancy, 2010")
hist(n_m1, breaks=10, xlab="Normalized Age (years)", col="lightblue", main="Male life expectancy, 2010")
hist(f1, breaks=10, xlab="Age (years)", col="lightblue", main="Female life expectancy, 2010")
hist(n_f1, breaks=10, xlab="Normalized Age (years)", col="lightblue", main="Female life expectancy, 2010")

##Longevity improvement histograms
par(mfrow=c(2,2))
hist(dm1, breaks=10, xlab="Age (years)", col="lightblue", main="Male longevity improvement, 1985-2010")
hist(n_dm1, breaks=10, xlab="Normalized Age (years)", col="lightblue", main="Male longevity improvement, 1985-2010")
hist(df1, breaks=10, xlab="Age (years)", col="lightblue", main="Female longevity improvement, 1985-2010")
hist(n_df1, breaks=10, xlab="Normalized Age (years)", col="lightblue", main="Female longevity improvement, 1985-2010")

#Add normalized variables together
life <- n_m1 + n_dm1 + n_f1 + n_df1

#Normalize activity to 0-1 range
n_life = (life-min(life))/(max(life)-min(life))
#head(n_life)

# Histogram of original vs. normalized data
#par(mfrow=c(1,2))
#hist(life, breaks=10, xlab="Score", col="lightblue", main="Longevity metric")
hist(n_life, breaks=10, xlab="Normalized Score", col="lightblue", main="Longevity metric")

summary(n_life) #slight left skew

```

For each over-arching variable (ie. longevity), we read in the 4 variables listed above, normalized, and then compiled the over-arching variable as a summation of the normalized sub-variables.

The normalization of sub-variables and (later) over-arching variables was done in order to bring all data to a 0-to-1 scale via the following equation:

$$
Transformed.Values = \frac{(Values - Min)}{(Max - Min)}
$$

Upon normalization of our over-arching variables, we created our dependent 'healthy lifestyle' variable as a combination of longevity, obesity, and physical activity:

$$
Lifestyle = Normalized.Life - Normalized.Obesity + Normalized.Activity
$$

LEFT OFF HERE: left off copying over Obesity code (preprocessing line 158)

### Data Exploration & Preparation

```{r}

#baseline EDA: glimpse() and summary()
# glimpse(df)
# summary(df)

```

From the above output we see that we're dealing with 2 categorical variables, 23 numeric variables, and a significant NA count for numerous variables. We'll deal with NA values later and define our variables as:

* `State`: State identifier.
* `County`: County identifier.
* `health_score`: quantitative, dependent variable that provides a measure of 'healthy lifestyle' as a function of longevity, obesity, and physical activity.
* `Hvy`: quantitative, independent variable representative of percent of population that drink heavily (how many drinks)
* `HvyPctChg`
* `Bng`
* `BngPctChg`
* `Mortality`
* `MortalityChg`
* `LTHighSchool`
* `HighSchool`
* `SomeCollege`
* `College`
* `EQI`
* `FoodInsecurity`
* `Sun`
* `Unemployment`
* `UnemploymentChg`
* `Poverty`
* `Income`
* `Population`
* `Births`
* `Deaths`
* `NetMig`
* `PopChg`

The categorical variables are our states and counties and not of much use for anything beyond identification. For this reason, our exploratory data analysis (EDA) focuses on the numeric variables.

As a next step, we explore their numeric distributions:

```{r}

#drop NAs from consideration
# df <- drop_na(df)
# dim(df) #3154 - 3004 = 150 dropped observations
# 
# #skimr, inspectdf - no visible graphic ... 
# #inspectdf::inspect_num(df) %>%
# # show_plot()
# 
# #Histograms for all variables
# df %>%
#     keep(is.numeric) %>%
#     gather() %>% 
#     ggplot(aes(value)) +
#         facet_wrap(~ key, scales = "free", ncol=4) +
#         geom_histogram(bins=90,color="darkblue", fill="lightblue")

```

We're dealed with varied distributions based on the variable:

* **Right skewed**:
* **Left skewed**:
* **Normal**:

We also see that our scales are quite varied, which for generalized linear regression models can present a problem and so normalization will have to be accounted for when we prepare our data.

```{r}

#boxplot vs. target

# names <- df %>% select_if(is.numeric)
# int_names <- names(names)
# 
# for (i in int_names) {
#   assign(paste0("var_",i), ggplot(df, aes_string(x = df$health_score, y = i)) + 
#           geom_boxplot(color = 'steelblue', 
#                        outlier.color = 'firebrick', 
#                        outlier.alpha = 0.35) +
#           #scale_y_continuous(labels = comma) +
#           labs(title = paste0(i,' vs target'), y = i, x= 'target') +
#           theme_minimal() + 
#           theme(
#             plot.title = element_text(hjust = 0.45),
#             panel.grid.major.y =  element_line(color = "grey", linetype = "dashed"),
#             panel.grid.major.x = element_blank(),
#             panel.grid.minor.y = element_blank(),
#             panel.grid.minor.x = element_blank(),
#             axis.ticks.x = element_line(color = "grey"),
#             text = element_text(size=16)
#           ))
# }
# gridExtra::grid.arrange(var_Births, var_Bng, var_BngPctChg, var_College, var_Deaths, var_EQI, var_FoodInsecurity, var_HighSchool, var_Hvy, var_HvyPctChg, var_Income, var_LTHighSchool, var_Mortality, var_MortalityChg, var_NetMig, var_PopChg, var_Population, var_Poverty, var_SomeCollege, var_Sun, var_Unemployment, var_UnemploymentChg, nrow=4)

```

Interpretation and transition ...

```{r}

#pairs plot and correlation matrix
# ##Pairs plot
# pairs(df %>% select_if(is.numeric))
# 
# ##Correlation matrix
# numeric_values <- df %>% select_if(is.numeric)
# df_cor <- cor(numeric_values)
# corrplot.mixed(df_cor, tl.col = 'black', tl.pos = 'lt')

```

LEFT OFF HERE

```{r}

#address NAs - DONE

#multicollinearity

#outliers

#normalization
```

### Multivariate Regression Analysis

```{r}

#Baseline model (model 1)
# df_base <- subset(df, select=-c(1,2)) #categorical columns
# model_1 <- lm(health_score ~., data = df_base)
# summary(model_1) #R^2 = 0.6725, vars = 23
# 
# #AIC optimized model (model 2)
# stepAIC(model_1)
# model_2 <- lm(formula = health_score ~ Hvy + HvyPctChg + Bng + BngPctChg + 
#     Mortality + HighSchool + SomeCollege + College + EQI + FoodInsecurity + 
#     Sun + Unemployment + UnemploymentChg + Poverty + Population + 
#     Births + Deaths + NetMig, data = df_base)
# summary(model_2) #R^2 = 0.672, vars = 18

```

## Conclusions & Next Steps

What have I learned?

Areas for Future Research

## Bibliography

## Appendix with Code

```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}

```

How have we done this in the past? (ie. DATA 621)